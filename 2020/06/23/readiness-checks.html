<!DOCTYPE html>
<html>
	<head>
		
			<title>How to add Readiness Checks for Google App Engine on Django - a3y3 - Soham Dongargaonkar</title>
		
		<meta name="viewport" content="width=device-width">
		<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Raleway">

		<link rel="stylesheet" type="text/css" href="/assets/css/bootstrap.css">
		<link rel="stylesheet" type="text/css" href="/assets/css/styles.css">
		<!-- Begin Jekyll SEO tag v2.6.1 -->
<title>How to add Readiness Checks for Google App Engine on Django</title>
<meta name="generator" content="Jekyll v4.1.0" />
<meta property="og:title" content="How to add Readiness Checks for Google App Engine on Django" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="A short tutorial for adding readiness checks for GAE, with explanation and unit tests." />
<meta property="og:description" content="A short tutorial for adding readiness checks for GAE, with explanation and unit tests." />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-06-23T00:00:00-04:00" />
<script type="application/ld+json">
{"url":"/2020/06/23/readiness-checks.html","headline":"How to add Readiness Checks for Google App Engine on Django","dateModified":"2020-06-23T00:00:00-04:00","datePublished":"2020-06-23T00:00:00-04:00","mainEntityOfPage":{"@type":"WebPage","@id":"/2020/06/23/readiness-checks.html"},"description":"A short tutorial for adding readiness checks for GAE, with explanation and unit tests.","@type":"BlogPosting","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

	</head>
	<body data-theme="dark">
		<nav class="navbar navbar-expand-md navbar-light">
			<a class="navbar-brand" href="/">Home</a>
			<button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
			<span class="navbar-toggler-icon"></span>
			</button>
			<div class="collapse navbar-collapse" id="navbarSupportedContent">
				<ul class="navbar-nav mr-auto">
					<li class="nav-item">
						<a class="nav-link" href="/projects.html">Projects</a>
					</li>
					<li class="nav-item">
						<a class="nav-link" href="/about.html">About</a>
					</li>
					<label class="switch" style="margin-top: 10px; margin-left: 10px;">
						<input type="checkbox" id="theme-switch" checked="checked">
						<span class="slider round"></span>
					</label>
				</ul>
			</div>
		</nav>
		<div class="container">
			<div class="content">
				<h1>How to add Readiness Checks for Google App Engine on Django</h1>
<p>23 Jun 2020</p>
<h3>Readiness Checks</h3>
<p> A while ago I was tasked with adding <a href="https://cloud.google.com/appengine/docs/flexible/custom-runtimes/configuring-your-app-with-app-yaml#readiness_checks">readiness checks</a> for a Django App. This wasn't as straight forward as I had hoped, so here's a tutorial for the next person who has to do this.</p>
<p>The very first thing you need to do is add a new <a href="https://docs.djangoproject.com/en/3.0/topics/http/middleware/">Middleware</a>, say, <code>HealthCheckMiddleware</code> to your Django app. Adding an API via a middleware and not a view might seem strange at first, but it's important that you do this, because your readiness check must be executed before anything else, including Django's inbuilt middleware chain. The skeleton for the middleware will look like:</p>
<pre>
class HealthCheckMiddleware:
  def __init__(self, get_response):
      self.get_response = get_response

  def __call__(self, request):
      return self.get_response(request)
</pre>

<p>In your <code>settings.py</code>, make sure this middleware is executed before everything else by adding it to the top of the list of the middlewares:</p>
<pre>
MIDDLEWARE = [
  'path.to.HealthCheckMiddleware',
  'django.middleware.common.CommonMiddleware',
    .
    .
    .
  ]
</pre>
<p>The next step is to write code to handle the request itself in the middleware. Readiness usually means that your app is up and can connect to the database. Since this API is going to be called pretty frequently by App Engine, we need to make sure the operation is as light as possible:</p>
<pre>
def __call__(self, request, conn=None):  # conn allow tests to pass custom db conn objects to test failures
  if request.method == "GET":
      if request.path == "/readiness_check/":
          try:  # try to connect to the database
              if not conn:
                  from django.db import connection as conn
              cursor = conn.cursor()
              cursor.execute("SELECT 1;")
              row = cursor.fetchone()
              if row is None:
                  return HttpResponse(503)
              return HttpResponse(status=200)  # No errors, return 200 OK

          except Exception:  # Any error while connecting, return 503
              return HttpResponse(status=503)

return self.get_response(request)
</pre>
<p>The final step is to tell Google App Engine how and when to call this API. Add the following to your <code>app.yaml</code>:</p>
<pre>
readiness_check:
path: "/readiness_check/"
check_interval_sec: 5
timeout_sec: 4
failure_threshold: 2
success_threshold: 2
app_start_timeout_sec: 300
</pre>
<p>You should consider tweaking these values. For an explanation of what they mean, check out the docs <a href="https://cloud.google.com/appengine/docs/flexible/custom-runtimes/configuring-your-app-with-app-yaml#readiness_checks">here.</a></p>

<h3>Unit Tests</h3>
<p>Nothing is complete without adding unit tests. To do this, we'll add 2 unit tests, one that tests if the API returns 200 OK on a successful connection to the database, and a test for checking if there's no connection to the database (and if the 503 is indeed being returned). Simulating the broken database postgresql connection in Django was a little tricky, since I couldn't find documentation online, and using tools like <code>destroy_test_db</code> freaks out the tests as Django thinks something has gone wrong. I was stuck for quite a while on this when my mentor suggested this great idea of passing a database <code>connection</code> object to the middleware, so it can use that instead of using the default <code>connection</code> object. Since we now control what connection the middleware uses, we can pass a <a href="https://docs.python.org/3/library/unittest.mock.html">mock database object</a> to it (and break it using a <code>side_effect</code>). Using mocks revealed a host of new Google search results, compared to what I was searching (and struggling with) before.</p>
<p>Add the following code to your <code>tests.py</code>:</p>
<pre>
  class HealthCheckMiddlewareTestCase(TestCase):
      readiness_url = 'https://your-domain.com/readiness_check/'

      def test_readiness_okay(self):
          request = RequestFactory().get(self.readiness_url)
          health_check = HealthCheckMiddleware(None)
          response = health_check(request)
          self.assertEqual(response.status_code, 200)

      def test_readiness_failure(self):
          with patch.object(psycopg2, 'connect') as connect_method:
              connect_method.cursor.side_effect = Exception(
                  'Random Database Connection Error')

              request = RequestFactory().get(self.readiness_url)
              health_check = HealthCheckMiddleware(None)
              response = health_check(request, connect_method)
              self.assertEqual(response.status_code, 503)
</pre>
<p>And that's it! You can see if it worked fine by running <code>python manage.py test tests.HealthCheckMiddlewareTestCase</code>. You can now be rest assured that App Engine will only route traffic to your instance only when it can successfully connect to your database!</p>


<div id="disqus_thread"></div>
<script>
var disqus_config = function () {
this.page.url = "https://a3y3.dev" + "/2020/06/23/readiness-checks.html";
this.page.identifier = "2020-06-23 00:00:00 -0400";
};

(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://a3y3-dev.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>This page uses Disqus for comments which uses Javascript. Please enable if you wish to participate!</noscript>

			</div>
		</div>
		<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
		<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
		<script type="text/javascript" src="/assets/js/js.cookie.js"></script>
		<script type="text/javascript" src="/assets/js/main.js"></script>
	</body>
</html>